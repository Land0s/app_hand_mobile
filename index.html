<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AR + –ñ–µ—Å—Ç—ã (three.js + MediaPipe)</title>
  <style>
    html, body { margin:0; padding:0; overflow:hidden; width:100%; height:100%; }
    /* —Ñ–æ–Ω: –≤–∏–¥–µ–æ —Å –∫–∞–º–µ—Ä—ã */
    #cam {
      position:absolute; top:0; left:0;
      width:100%; height:100%;
      object-fit:cover;
      transform:scaleX(-1); /* –∑–µ—Ä–∫–∞–ª–∫–∞ –¥–ª—è —Å–µ–ª—Ñ–∏-–æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ */
    }
    /* –ø–æ–≤–µ—Ä—Ö: three.js —Ä–µ–Ω–¥–µ—Ä */
    #three-canvas {
      position:absolute; top:0; left:0;
      width:100%; height:100%;
      pointer-events:none; /* –∫–ª–∏–∫–∏ –Ω–∞ –≤–∏–¥–µ–æ */
    }
  </style>

  <!-- VConsole (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –Ω–∞ iPhone) -->
  <script src="https://unpkg.com/vconsole@3.15.0/dist/vconsole.min.js"></script>
  <script> new VConsole(); </script>
  
  <!-- three.js –∏ GLTFLoader —á–µ—Ä–µ–∑ CDN -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/loaders/GLTFLoader.js"></script>
  
  <!-- MediaPipe Hands + Camera Utils —á–µ—Ä–µ–∑ CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
</head>
<body>
  <video id="cam" autoplay playsinline muted></video>
  <canvas id="three-canvas"></canvas>

  <script>
    // 1) –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã
    const video = document.getElementById('cam');
    navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } })
      .then(stream => {
        console.log('üé• –ö–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞');
        video.srcObject = stream;
      })
      .catch(err => {
        console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:', err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É:\n' + err.message);
      });

    // 2) –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è three.js
    const canvas   = document.getElementById('three-canvas');
    const renderer = new THREE.WebGLRenderer({ canvas, alpha:true, antialias:true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    // –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏: –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –∫—Ä–∞—Å–Ω—ã–π —Ñ–æ–Ω
    renderer.setClearColor(0xff0000, 0.3);

    const scene  = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 100);
    camera.position.set(0, 0, 1);
    scene.add( new THREE.HemisphereLight(0xffffbb, 0x080820, 1) );

    // 3) –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏
    let model = null;
    const loader = new THREE.GLTFLoader();
    loader.load(
      'model.glb',
      gltf => {
        console.log('‚úÖ –ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        model = gltf.scene;
        model.scale.set(0.2, 0.2, 0.2);
        scene.add(model);
      },
      xhr => {
        if(xhr.total) {
          console.log(`–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏: ${(xhr.loaded/xhr.total*100).toFixed(1)}%`);
        }
      },
      err => {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ model.glb:', err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å 3D-–º–æ–¥–µ–ª—å:\n' + err.message);
      }
    );

    // 4) –ù–∞—Å—Ç—Ä–æ–π–∫–∞ MediaPipe Hands
    const hands = new Hands({
      locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
    });
    hands.setOptions({
      maxNumHands: 2,
      minDetectionConfidence: 0.7,
      minTrackingConfidence: 0.7
    });
    hands.onResults(onHands);

    // ¬´–ø—Ä–æ–∫–∏–Ω—É—Ç—å¬ª –≤–∏–¥–µ–æ –≤ MP
    const mpCam = new Camera(video, {
      onFrame: async () => {
        try { await hands.send({ image: video }); }
        catch(e){ console.error('hands.send error:', e); }
      },
      width: 640, height: 480
    });
    mpCam.start();

    // 5) –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∂–µ—Å—Ç–æ–≤
    let prevDist = null, prevAng = null;
    function onHands(results) {
      console.log('–†—É–∫ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ:', results.multiHandLandmarks.length);
      if(!model) return;

      const H = results.multiHandLandmarks;
      // ‚Äî –ø–∏–Ω—á –æ–¥–Ω–æ–π —Ä—É–∫–æ–π ‚Üí –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
      if(H.length === 1) {
        const lm = H[0];
        const d = Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y);
        if(d < 0.05) {
          const nx = lm[8].x * 2 - 1;
          const ny = -(lm[8].y * 2 - 1);
          model.position.set(nx * 0.5, ny * 0.5, 0);
        }
      }
      // ‚Äî –¥–≤–µ —Ä—É–∫–∏ ‚Üí –º–∞—Å—à—Ç–∞–± + –≤—Ä–∞—â–µ–Ω–∏–µ –≤–æ–∫—Ä—É–≥ Z
      else if(H.length === 2) {
        const A = H[0][8], B = H[1][8];
        // –º–∞—Å—à—Ç–∞–±
        const dist = Math.hypot(A.x - B.x, A.y - B.y);
        if(prevDist !== null) {
          const sf = dist / prevDist;
          model.scale.multiplyScalar(sf);
        }
        prevDist = dist;
        // –≤—Ä–∞—â–µ–Ω–∏–µ
        const ang = Math.atan2(B.y - A.y, B.x - A.x);
        if(prevAng !== null) {
          model.rotation.z += ang - prevAng;
        }
        prevAng = ang;
      } else {
        prevDist = prevAng = null;
      }
    }

    // 6) –ê–Ω–∏–º–∞—Ü–∏—è
    (function animate() {
      requestAnimationFrame(animate);
      renderer.render(scene, camera);
    })();

    // 7) –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Å–∞–π–∑–∞
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
