<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AR + –ñ–µ—Å—Ç—ã (three.js + HandTrack.js)</title>
  <style>
    html, body { margin: 0; padding: 0; overflow: hidden; width: 100%; height: 100%; }
    #cam {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      transform: scaleX(-1); /* –ó–µ—Ä–∫–∞–ª–∫–∞ –¥–ª—è —Å–µ–ª—Ñ–∏ */
    }
    #three-canvas {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
    }
  </style>

  <!-- VConsole –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ -->
  <script src="https://unpkg.com/vconsole@3.15.0/dist/vconsole.min.js"></script>
  <script>new VConsole();</script>

  <!-- three.js —á–µ—Ä–µ–∑ CDN -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>

  <!-- HandTrack.js —á–µ—Ä–µ–∑ CDN -->
  <script src="https://unpkg.com/@tensorflow/tfjs@3.9.0/dist/tf.min.js"></script>
  <script src="https://unpkg.com/handtrackjs@0.1.8/dist/handtrack.min.js"></script>
</head>
<body>
  <video id="cam" autoplay playsinline muted></video>
  <canvas id="three-canvas"></canvas>

  <script>
    // 1) –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã
    const video = document.getElementById('cam');
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
      .then(stream => {
        console.log('üé• –ö–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞');
        video.srcObject = stream;
      })
      .catch(err => {
        console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:', err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É:\n' + err.message);
      });

    // 2) –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è three.js
    const canvas = document.getElementById('three-canvas');
    const renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);

    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 100);
    camera.position.set(0, 0, 1);
    scene.add(new THREE.HemisphereLight(0xffffbb, 0x080820, 1));

    // 3) –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫–∞
    const geometry = new THREE.BufferGeometry();
    const vertices = new Float32Array([
      0, 0.2, 0,   // –í–µ—Ä—à–∏–Ω–∞ 1
      -0.2, -0.2, 0, // –í–µ—Ä—à–∏–Ω–∞ 2
      0.2, -0.2, 0   // –í–µ—Ä—à–∏–Ω–∞ 3
    ]);
    geometry.setAttribute('position', new THREE.BufferAttribute(vertices, 3));
    const material = new THREE.MeshBasicMaterial({ color: 0x00ff00, side: THREE.DoubleSide });
    const triangle = new THREE.Mesh(geometry, material);
    triangle.scale.set(0.2, 0.2, 0.2);
    scene.add(triangle);

    // 4) –ù–∞—Å—Ç—Ä–æ–π–∫–∞ HandTrack.js
    let model = null;
    const modelParams = {
      flipHorizontal: true, // –ó–µ—Ä–∫–∞–ª–∏–º –¥–ª—è –≤–∏–¥–µ–æ
      maxNumBoxes: 2,       // –ú–∞–∫—Å–∏–º—É–º 2 —Ä—É–∫–∏
      iouThreshold: 0.5,
      scoreThreshold: 0.7   // –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
    };

    handTrack.load(modelParams).then(lmodel => {
      console.log('‚úÖ HandTrack.js –∑–∞–≥—Ä—É–∂–µ–Ω');
      model = lmodel;
      startHandTracking();
    });

    function startHandTracking() {
      model.getVideo().srcObject = video.srcObject;
      model.startVideo(video).then(status => {
        if (status) {
          console.log('–í–∏–¥–µ–æ –¥–ª—è HandTrack –∑–∞–ø—É—â–µ–Ω–æ');
          trackHands();
        } else {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –≤–∏–¥–µ–æ HandTrack');
        }
      });
    }

    let prevDist = null, prevAng = null;
    function trackHands() {
      model.detect(video).then(predictions => {
        console.log('–†—É–∫ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ:', predictions.length);
        if (!triangle) return;

        // –û–¥–Ω–∞ —Ä—É–∫–∞: –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
        if (predictions.length === 1) {
          const box = predictions[0].bbox;
          const nx = (box[0] + box[2] / 2) / video.videoWidth * 2 - 1;
          const ny = -((box[1] + box[3] / 2) / video.videoHeight * 2 - 1);
          triangle.position.set(nx * 0.5, ny * 0.5, 0);
        }
        // –î–≤–µ —Ä—É–∫–∏: –º–∞—Å—à—Ç–∞–± –∏ –≤—Ä–∞—â–µ–Ω–∏–µ
        else if (predictions.length === 2) {
          const A = { x: (predictions[0].bbox[0] + predictions[0].bbox[2] / 2) / video.videoWidth,
                      y: (predictions[0].bbox[1] + predictions[0].bbox[3] / 2) / video.videoHeight };
          const B = { x: (predictions[1].bbox[0] + predictions[1].bbox[2] / 2) / video.videoWidth,
                      y: (predictions[1].bbox[1] + predictions[1].bbox[3] / 2) / video.videoHeight };

          // –ú–∞—Å—à—Ç–∞–±
          const dist = Math.hypot(A.x - B.x, A.y - B.y);
          if (prevDist !== null) {
            const sf = dist / prevDist;
            triangle.scale.multiplyScalar(sf);
          }
          prevDist = dist;

          // –í—Ä–∞—â–µ–Ω–∏–µ
          const ang = Math.atan2(B.y - A.y, B.x - A.x);
          if (prevAng !== null) {
            triangle.rotation.z += ang - prevAng;
          }
          prevAng = ang;
        } else {
          prevDist = prevAng = null;
        }

        requestAnimationFrame(trackHands);
      });
    }

    // 5) –ê–Ω–∏–º–∞—Ü–∏—è
    (function animate() {
      requestAnimationFrame(animate);
      renderer.render(scene, camera);
    })();

    // 6) –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Å–∞–π–∑–∞
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
