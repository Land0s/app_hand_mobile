<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AR + –ñ–µ—Å—Ç—ã (TFJS + three.js)</title>
  <style>
    html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; }
    #cam {
      position:absolute; top:0; left:0;
      width:100%; height:100%;
      object-fit:cover;
      transform:scaleX(-1);
    }
    #three-canvas {
      position:absolute; top:0; left:0;
      width:100%; height:100%;
      pointer-events:none;
    }
  </style>

  <!-- VConsole: –±—É–¥–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–æ–≥–∏ –ø—Ä—è–º–æ –Ω–∞ —ç–∫—Ä–∞–Ω–µ iPhone -->
  <script src="https://unpkg.com/vconsole@3.15.0/dist/vconsole.min.js"></script>
  <script> new VConsole(); </script>

  <!-- TFJS –∏ Hand Pose Detection (–∫–∞–∫ UMD, —á—Ç–æ–±—ã –¥–æ—Å—Ç–∞—Ç—å –≥–ª–æ–±–∞–ª—ã tf –∏ handPoseDetection) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/hand-pose-detection@0.0.7/dist/hand-pose-detection.js"></script>
</head>
<body>
  <video id="cam" autoplay playsinline muted></video>
  <canvas id="three-canvas"></canvas>

  <script type="module">
    // 1) –ò–º–ø–æ—Ä—Ç three.js –∫–∞–∫ ES-–º–æ–¥—É–ª–∏
    import * as THREE       from 'https://unpkg.com/three@0.152.2/build/three.module.js';
    import { GLTFLoader }   from 'https://unpkg.com/three@0.152.2/examples/jsm/loaders/GLTFLoader.js';

    (async ()=> {
      // 2) –ö–∞–º–µ—Ä–∞
      const video = document.getElementById('cam');
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } });
        console.log('üé• –ö–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞');
        video.srcObject = stream;
      } catch(err) {
        console.error('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:', err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É:\n' + err.message);
        return;
      }

      // 3) three.js —Å—Ü–µ–Ω–∞
      const canvas   = document.getElementById('three-canvas');
      const renderer = new THREE.WebGLRenderer({ canvas, alpha:true, antialias:true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setClearColor(0xff0000, 0.3); // –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π —Ñ–æ–Ω

      const scene  = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 100);
      camera.position.set(0,0,1);
      scene.add( new THREE.HemisphereLight(0xffffbb, 0x080820, 1) );

      // 4) –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏
      let model = null;
      new GLTFLoader().load(
        'model.glb',
        gltf => {
          console.log('‚úÖ –ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
          model = gltf.scene;
          model.scale.set(0.2,0.2,0.2);
          scene.add(model);
        },
        xhr => {
          if(xhr.total) console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${(xhr.loaded/xhr.total*100).toFixed(1)}%`);
        },
        err => {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ model.glb:', err);
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å:\n' + err.message);
        }
      );

      // 5) –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TFJS-–¥–µ—Ç–µ–∫—Ç–æ—Ä–∞
      await tf.setBackend('webgl');
      const detector = await handPoseDetection.createDetector(
        handPoseDetection.SupportedModels.MediaPipeHands,
        { runtime:'tfjs', modelType:'full' }
      );
      console.log('ü§ñ –î–µ—Ç–µ–∫—Ç–æ—Ä –≥–æ—Ç–æ–≤');

      // 6) –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–¥—Ä–æ–≤ –∏ –∂–µ—Å—Ç–æ–≤
      let prevDist = null, prevAng = null;
      async function detect() {
        if(video.readyState >= 2 && model) {
          const hands = await detector.estimateHands(video, { flipHorizontal:true });
          if(hands.length === 1) {
            const tip = hands[0].keypoints.find(p=>p.name==='index_finger_tip');
            const thumb= hands[0].keypoints.find(p=>p.name==='thumb_tip');
            const d = Math.hypot(tip.x-thumb.x, tip.y-thumb.y);
            if(d < 40) {
              const nx = (tip.x/video.videoWidth)*2 - 1;
              const ny = -(tip.y/video.videoHeight)*2 + 1;
              model.position.set(nx*0.5, ny*0.5, 0);
            }
          } else if(hands.length === 2) {
            const A = hands[0].keypoints.find(p=>p.name==='index_finger_tip');
            const B = hands[1].keypoints.find(p=>p.name==='index_finger_tip');
            const dist = Math.hypot(A.x-B.x, A.y-B.y);
            if(prevDist !== null) model.scale.multiplyScalar(dist/prevDist);
            prevDist = dist;
            const ang = Math.atan2(B.y-A.y, B.x-A.x);
            if(prevAng !== null) model.rotation.z += ang - prevAng;
            prevAng = ang;
          } else {
            prevDist = prevAng = null;
          }
        }
      }

      // 7) –†–µ–Ω–¥–µ—Ä + –¥–µ—Ç–µ–∫—Ü–∏—è –≤ —Ü–∏–∫–ª–µ
      function animate() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
        detect();
      }
      animate();

      // 8) –†–µ—Å–∞–π–∑
      window.addEventListener('resize', ()=>{
        camera.aspect = window.innerWidth/window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });
    })();
  </script>
</body>
</html>
