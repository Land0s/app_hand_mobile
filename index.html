<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AR + –ñ–µ—Å—Ç—ã (—Å –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏)</title>
  <style>
    html, body { margin:0; padding:0; overflow:hidden; width:100%; height:100%; }
    #cam {
      position:absolute; top:0; left:0;
      width:100%; height:100%;
      object-fit:cover;
      transform:scaleX(-1);
    }
    #three-canvas {
      position:absolute; top:0; left:0;
      width:100%; height:100%;
      pointer-events:none;
    }
  </style>
  <!-- VConsole –¥–ª—è –ª–æ–≥–æ–≤ –Ω–∞ iPhone -->
  <script src="https://unpkg.com/vconsole@3.15.0/dist/vconsole.min.js"></script>
  <script> new VConsole(); </script>
</head>
<body>
  <video id="cam" autoplay playsinline muted></video>
  <canvas id="three-canvas"></canvas>

  <script type="module">
    import * as THREE         from 'https://unpkg.com/three@0.152.2/build/three.module.js';
    import { GLTFLoader }     from 'https://unpkg.com/three@0.152.2/examples/jsm/loaders/GLTFLoader.js';
    import { Hands }          from 'https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/hands.js';
    import { Camera as MPCam} from 'https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.4/camera_utils.js';

    const video = document.getElementById('cam');
    const canvas = document.getElementById('three-canvas');

    // 1) –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É
    navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } })
      .then(stream => {
        console.log('üé• –ö–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞:', stream);
        video.srcObject = stream;
      })
      .catch(err => {
        console.error('‚ùå getUserMedia error:', err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ:\n' + err.message);
      });

    // 2) –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º three.js
    const renderer = new THREE.WebGLRenderer({ canvas, alpha:true, antialias:true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    // –∑–∞–ª–∏–≤–∫–∞ –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º –∫—Ä–∞—Å–Ω—ã–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ —Ä–µ–Ω–¥–µ—Ä–∞
    renderer.setClearColor(0xff0000, 0.3);

    const scene  = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 100);
    camera.position.set(0,0,1);
    scene.add(new THREE.HemisphereLight(0xffffbb, 0x080820, 1));

    // 3) –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª—å —Å –ª–æ–≥–∞–º–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏ –æ—à–∏–±–æ–∫
    let model = null;
    const loader = new GLTFLoader();
    loader.load(
      'model.glb',
      gltf => {
        console.log('‚úÖ –ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        model = gltf.scene;
        model.scale.set(0.2,0.2,0.2);
        scene.add(model);
      },
      xhr => {
        if (xhr.total) {
          console.log(`–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏: ${(xhr.loaded/xhr.total*100).toFixed(1)}%`);
        } else {
          console.log(`–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏: ${xhr.loaded} –±–∞–π—Ç`);
        }
      },
      err => {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ model.glb:', err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å 3D-–º–æ–¥–µ–ª—å:\n' + err.message);
      }
    );

    // 4) –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Mediapipe Hands
    const hands = new Hands({
      locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/${file}`
    });
    hands.setOptions({
      maxNumHands: 2,
      minDetectionConfidence: 0.7,
      minTrackingConfidence: 0.7
    });
    hands.onResults(onHands);

    const mpCam = new MPCam(video, {
      onFrame: async () => {
        try {
          await hands.send({image: video});
        } catch(e) {
          console.error('‚ùå hands.send error:', e);
        }
      },
      width: 640,
      height: 480
    });
    mpCam.start();

    // 5) –û–±—Ä–∞–±–æ—Ç–∫–∞ –∂–µ—Å—Ç–æ–≤ —Å –ª–æ–≥–∞–º–∏
    let prevDist = null, prevAng = null;
    function onHands(results) {
      console.log('‚úã onHands, —Ä—É–∫:', results.multiHandLandmarks.length);
      if (!model) return;

      const H = results.multiHandLandmarks;
      if (H.length === 0) {
        prevDist = prevAng = null;
        return;
      }

      // –ü–∏–Ω—á –æ–¥–Ω–æ–π —Ä—É–∫–æ–π ‚Üí –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
      if (H.length === 1) {
        const lm = H[0];
        const d = Math.hypot(lm[4].x - lm[8].x, lm[4].y - lm[8].y);
        if (d < 0.05) {
          const nx = lm[8].x * 2 - 1;
          const ny = -(lm[8].y * 2 - 1);
          model.position.set(nx * 0.5, ny * 0.5, 0);
          console.log('üöö –ü–µ—Ä–µ–º–µ—Å—Ç–∏–ª–∏ –º–æ–¥–µ–ª—å –≤', model.position);
        }
      }

      // –î–≤–µ —Ä—É–∫–∏ ‚Üí –º–∞—Å—à—Ç–∞–± –∏ –≤—Ä–∞—â–µ–Ω–∏–µ
      if (H.length === 2) {
        const A = H[0][8], B = H[1][8];
        const dist = Math.hypot(A.x - B.x, A.y - B.y);
        if (prevDist !== null) {
          const scaleFactor = dist / prevDist;
          model.scale.multiplyScalar(scaleFactor);
          console.log('üîç –ú–∞—Å—à—Ç–∞–± –º–æ–¥–µ–ª–∏:', model.scale.x.toFixed(2));
        }
        prevDist = dist;

        const ang = Math.atan2(B.y - A.y, B.x - A.x);
        if (prevAng !== null) {
          const delta = ang - prevAng;
          model.rotation.z += delta;
          console.log('üîÑ –í—Ä–∞—â–µ–Ω–∏–µ Z:', model.rotation.z.toFixed(2));
        }
        prevAng = ang;
      }
    }

    // 6) –ê–Ω–∏–º–∞—Ü–∏—è
    function animate() {
      requestAnimationFrame(animate);
      renderer.render(scene, camera);
    }
    animate();

    // 7) –ü–µ—Ä–µ—Å—á—ë—Ç –ø—Ä–∏ —Ä–µ—Å–∞–π–∑–µ
    window.addEventListener('resize', ()=>{
      camera.aspect = window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
