<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AR + –ñ–µ—Å—Ç—ã –Ω–∞ TFJS + three.js</title>
  <style>
    html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; }
    #cam {
      position:absolute; top:0; left:0;
      width:100%; height:100%;
      object-fit:cover;
      transform:scaleX(-1);
    }
    #three-canvas {
      position:absolute; top:0; left:0;
      width:100%; height:100%;
      pointer-events:none;
    }
  </style>

  <!-- VConsole –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –Ω–∞ iPhone -->
  <script src="https://unpkg.com/vconsole@3.15.0/dist/vconsole.min.js"></script>
  <script> new VConsole(); </script>

  <!-- three.js –∏ GLTFLoader -->
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.152.2/examples/js/loaders/GLTFLoader.js"></script>

  <!-- TensorFlow.js –∏ Hand Pose Detection -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.12.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/hand-pose-detection@0.0.7/dist/hand-pose-detection.js"></script>
</head>
<body>
  <video id="cam" autoplay playsinline muted></video>
  <canvas id="three-canvas"></canvas>

  <script>
  (async ()=>{

    // 1Ô∏è‚É£ –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É
    const video = document.getElementById('cam');
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } });
      console.log('üé• –ö–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞');
      video.srcObject = stream;
    } catch(err) {
      console.error('‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ', err);
      alert('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É:\n'+err.message);
      return;
    }

    // 2Ô∏è‚É£ three.js —Å—Ü–µ–Ω–∞
    const canvas   = document.getElementById('three-canvas');
    const renderer = new THREE.WebGLRenderer({ canvas, alpha:true, antialias:true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    // –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏: –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –∫—Ä–∞—Å–Ω—ã–π —Ñ–æ–Ω
    renderer.setClearColor(0xff0000, 0.3);

    const scene  = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 100);
    camera.position.set(0,0,1);
    scene.add(new THREE.HemisphereLight(0xffffbb, 0x080820, 1));

    // 3Ô∏è‚É£ –ó–∞–≥—Ä—É–∑–∫–∞ 3D-–º–æ–¥–µ–ª–∏
    let model = null;
    new THREE.GLTFLoader().load(
      'model.glb',
      gltf => {
        console.log('‚úÖ –ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        model = gltf.scene;
        model.scale.set(0.2,0.2,0.2);
        scene.add(model);
      },
      xhr => {
        if(xhr.total) console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${(xhr.loaded/xhr.total*100).toFixed(1)}%`);
      },
      err => {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ model.glb', err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å:\n'+err.message);
      }
    );

    // 4Ô∏è‚É£ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞ –∂–µ—Å—Ç–æ–≤
    await tf.setBackend('webgl'); // WebGL-–±—ç–∫–µ–Ω–¥ –≤ Safari
    const modelName    = handPoseDetection.SupportedModels.MediaPipeHands;
    const detectorOpts = { runtime: 'tfjs', modelType: 'full' };
    const detector     = await handPoseDetection.createDetector(modelName, detectorOpts);
    console.log('ü§ñ –î–µ—Ç–µ–∫—Ç–æ—Ä –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (tfjs)');

    // 5Ô∏è‚É£ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–¥—Ä–æ–≤
    let prevDist = null, prevAng = null;
    async function processFrame() {
      if (!video.readyState || video.paused) return;
      const hands = await detector.estimateHands(video, { flipHorizontal: true });
      // hands ‚Äî –º–∞—Å—Å–∏–≤ –∏–∑ 0,1 –∏–ª–∏ 2 –æ–±—ä–µ–∫—Ç–æ–≤
      if (model && hands.length) {
        // Pinch –æ–¥–Ω–æ–π —Ä—É–∫–æ–π ‚Üí –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
        if (hands.length === 1) {
          const kp = hands[0].keypoints.find(p=>p.name==='index_finger_tip');
          const thumb = hands[0].keypoints.find(p=>p.name==='thumb_tip');
          const d = Math.hypot(kp.x - thumb.x, kp.y - thumb.y);
          if (d < 40) { // –ø–æ—Ä–æ–≥ –≤ –ø–∏–∫—Å–µ–ª—è—Ö, –º–æ–∂–Ω–æ –ø–æ–¥–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
            const nx = (kp.x / video.videoWidth)*2 - 1;
            const ny = -(kp.y / video.videoHeight)*2 + 1;
            model.position.set(nx*0.5, ny*0.5, 0);
          }
        }
        // –î–≤–µ —Ä—É–∫–∏ ‚Üí –º–∞—Å—à—Ç–∞–± + –≤—Ä–∞—â–µ–Ω–∏–µ
        else if (hands.length===2) {
          const a = hands[0].keypoints.find(p=>p.name==='index_finger_tip');
          const b = hands[1].keypoints.find(p=>p.name==='index_finger_tip');
          const dist = Math.hypot(a.x-b.x, a.y-b.y);
          if (prevDist!=null) model.scale.multiplyScalar(dist/prevDist);
          prevDist = dist;
          const ang = Math.atan2(b.y - a.y, b.x - a.x);
          if (prevAng!=null) model.rotation.z += ang - prevAng;
          prevAng = ang;
        } else {
          prevDist = prevAng = null;
        }
      }
    }

    // 6Ô∏è‚É£ –ê–Ω–∏–º–∞—Ü–∏—è
    function animate(){
      requestAnimationFrame(animate);
      renderer.render(scene, camera);
      processFrame();
    }
    animate();

    // 7Ô∏è‚É£ –†–µ—Å–∞–π–∑
    window.addEventListener('resize', ()=>{
      camera.aspect = window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

  })();
  </script>
</body>
</html>
